<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Excel部分一致検索（シート指定）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <style>
    table { border-collapse: collapse; }
    td, th { border: 1px solid #888; padding: 4px 8px; }
  </style>
</head>
<body>
  <h1>Excel部分一致検索（シート指定）</h1>
  <div>
    <label>シート名: <input type="text" id="sheetName" value=""></label>
    <button id="loadBtn">Excel読み込み</button>
  </div>
  <br>
  <div>
    <input type="text" id="keyword" placeholder="キーワードを入力">
    <button id="searchBtn">検索</button>
  </div>
  <div id="result"></div>
  <script>
    let excelData = [];
    let workbook = null;

    // ファイルのURL（GitHub Pages上のパスに合わせる）
    const EXCEL_URL = './data.xlsx';

    // Excel読み込み
    document.getElementById('loadBtn').onclick = async function() {
      const sheetName = document.getElementById('sheetName').value;
      if (!sheetName) {
        document.getElementById('result').innerHTML = 'シート名を入力してください。';
        return;
      }
      // fetchでバイナリ取得
      const res = await fetch(EXCEL_URL);
      const arrayBuffer = await res.arrayBuffer();
      workbook = XLSX.read(arrayBuffer, {type: 'array'});
      if (!workbook.SheetNames.includes(sheetName)) {
        document.getElementById('result').innerHTML = '指定されたシートが見つかりません。';
        return;
      }
      const sheet = workbook.Sheets[sheetName];
      excelData = XLSX.utils.sheet_to_json(sheet, {header:1});
      document.getElementById('result').innerHTML = `<b>シート「${sheetName}」を読み込みました。</b>`;
    };

    // 検索
    document.getElementById('searchBtn').onclick = function() {
      const keyword = document.getElementById('keyword').value;
      if (!excelData.length) {
        document.getElementById('result').innerHTML = 'Excelシートを先に読み込んでください。';
        return;
      }
      if (!keyword) {
        document.getElementById('result').innerHTML = 'キーワードを入力してください。';
        return;
      }
      // 部分一致で該当行抽出
      const matched = excelData.filter(
        row => row.some(cell => (cell+"").includes(keyword))
      );
      if (!matched.length) {
        document.getElementById('result').innerHTML = '一致する行がありません。';
        return;
      }
      // テーブルとして出力
      let html = '<table>';
      matched.forEach(row => {
        html += '<tr>' + row.map(cell => `<td>${cell??""}</td>`).join('') + '</tr>';
      });
      html += '</table>';
      document.getElementById('result').innerHTML = html;
    };
  </script>
</body>
</html>
